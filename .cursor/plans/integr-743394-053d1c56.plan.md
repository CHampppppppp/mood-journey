<!-- 053d1c56-89fa-494d-b232-f3508c4b68d0 5e063df2-3166-4ee3-a876-8cb93685ce0d -->
# 集成 DeepSeek + Chroma + RAG 的实现方案

### 1. 基础架构与依赖规划

- 在 `piggy` Next.js 应用中新增一套 LLM/RAG 后端：
- 使用 `/app/api` 下的 Route Handlers 暴露接口，例如：
- `app/api/chat/route.ts`：对话接口，调用 DeepSeek + RAG
- `app/api/embed/route.ts`：向量化 & 写入 Chroma（供心情记录和文件上传调用）
- 在 `lib` 目录新增/扩展：
- `lib/vectorStore.ts`：封装 Chroma 客户端操作（创建 collection、插入/查询向量等）。
- `lib/llm.ts`：封装 DeepSeek 的 HTTP 调用（模型 `deepseek-chat`）。
- 新增依赖：
- `chroma-js` 或 `@chroma-db/chroma-js`（视最新 SDK 而定）
- 一个嵌入模型 SDK（如 `@huggingface/inference` 或直接调用 DeepSeek 的 embedding 接口，如果可用）。

### 2. DeepSeek API 集成设计

- 在 `next.config.mjs`/`next.config.ts` 中允许访问外部 API 域名。
- 在项目根的 `.env.local` 中约定：
- `DEEPSEEK_API_KEY=...`
- `DEEPSEEK_API_BASE=https://api.deepseek.com`（如官方推荐地址不同则调整）。
- 在 `lib/llm.ts` 中实现：
- 一个 `callDeepseekChat(messages, systemPrompt)` 函数：
- 入参：对话历史（user/system/assistant）+ 系统角色提示词（扮演 Champ）。
- 输出：LLM 回复文本。
- 可选：`embedTextBatch(texts)`（若使用 DeepSeek 提供 embedding 接口）。

### 3. Chroma 向量库接入与数据 Schema

- 在项目根新建 `chroma/` 目录用于本地持久化（开发阶段）。
- 在 `lib/vectorStore.ts` 中：
- 初始化 Chroma 客户端，指定 `path: "./chroma"`。
- 设计一个主 collection，如 `piggy-memories`，字段：
- `id`：唯一 ID
- `text`：原始内容（心情记录正文、上传文件的片段等，存到 metadata）
- `type`：`"mood" | "file" | "note"` 等
- `author`：`"piggy" | "champ"`
- `datetime`：写入时间
- 提供方法：
- `addMemories(chunks: { id, text, metadata }[])`
- `searchMemories(query, k)`：返回 top-k 相似文本及元信息供 RAG 使用。

### 4. RAG 检索与对话流程设计

- 在 `app/api/chat/route.ts`：
- 接收前端传来的：`messages`（聊天历史）、`userId`（可选）、当前时间等。
- 从 `messages` 中取出最新一条用户消息作为检索 query。
- 调用 `searchMemories` 做向量检索：
- 根据 `piggy` 的输入，找出相关的心情记录、以往对话摘要、上传文件片段。
- 把检索结果整理为一个 `context` 文本块，例如：
- "以下是你和 Piggy 以前的记录与资料，供你回忆：..."。
- 构造系统提示词：
- 明确角色是 Champ（Piggy 的男朋友 & 网站作者），语气要求、称呼习惯等。
- 要求在回答中适度引用/回忆 context 中的信息，像「我记得你那天...」。
- 把 `system + context + user` 一起发送给 DeepSeek，返回回答。

### 5. 心情记录写入向量库的扩展

- 分析现有心情记录流水线（主要关注以下文件）：
- `app/components/MoodForm.tsx`
- `app/components/MoodHistory.tsx`
- `lib/actions.ts` / `lib/db.ts`（保存心情的 server action / DB 操作）。
- 在保存心情记录成功后：
- 在对应 server action / route 中增加一段逻辑：
- 拼接一段适合检索的文本，例如：
- `"日期：2025-11-26，心情：开心，详情：……"`。
- 调用 `embedTextBatch` 得到向量。
- 调用 `addMemories` 写入 `piggy-memories` collection，并带上 metadata：
- `type="mood"`，`author="piggy"`，`datetime` 等。
- 确保写入逻辑是异步非阻塞：
- 即使向量库写入失败，不影响心情记录本身成功保存（可以 log 错误）。

### 6. 支持上传文件并入库

- 新增一个上传入口（可在聊天弹窗或某个设置页）：
- 例如 `app/components/MemoryUploader.tsx`：
- 支持上传 TXT / PDF / Markdown / 图片（可先只做文本类）。
- 在 `app/api/upload-memory/route.ts` 中：
- 处理上传文件：解析文本（PDF 可用简单库或先约定只支持 TXT/MD）。
- 对长文本进行切分（按段落/固定字数切块）。
- 对每个 chunk 调用 `embedTextBatch`，写入 `piggy-memories`。
- metadata 中标记 `type="file"`，`sourceFilename` 等信息。

### 7. 右下角圆形聊天入口 UI 设计

- 在 `app/components` 下新增：
- `ChatWidget.tsx`：整体封装聊天控件。
- UI 行为：
- 右下角悬浮一个圆形按钮：
- 使用 `next/image` 显示 `public/L.png` 作为头像。
- 样式：圆形、带阴影、hover 动画。
- 点击按钮后：
- 展开一个带圆角的对话面板（可固定宽高，比如 360×520），浮在右下角。
- 面板包含：
- 顶部标题（例如「和 Champ 聊聊」）+ 关闭按钮。
- 中间：对话消息列表。
- 底部：输入框 + 发送按钮。
- 技术实现细节：
- 使用 React `useState` 控制展开/收起。
- 使用现有的 `ToastProvider.tsx` 风格保证视觉统一。
- 在 `app/layout.tsx` 中全局挂载 `ChatWidget` 组件，使任何页面都能访问助手。

### 8. 前端聊天逻辑与状态管理

- 在 `ChatWidget.tsx`：
- 管理对话状态 `messages`（数组：`{role: 'user'|'assistant'|'system', content}`）。
- 发送流程：
- 用户输入 → push 到本地 `messages` → 调用 `/api/chat`。
- 后端返回答案后，append 一条 assistant 消息。
- Loading & 错误处理：
- 显示“Champ 正在思考...”的加载态。
- 出错时在聊天内显示一条系统消息，提示稍后重试。
- 可选：本地持久化最近若干轮对话到 `localStorage`，刷新页面后还能看到。

### 9. 人设与提示词（让 LLM 像你一样说话）

- 在 `lib/llm.ts` 或 `app/api/chat/route.ts` 中定义一个 `SYSTEM_PROMPT`：
- 内容要点：
- 你是 Champ，是 Piggy 的男朋友，也是这个心情网站的作者。
- 你熟悉 Piggy 以往的心情记录和上传的资料，会用这些内容来“回忆”。
- 说话风格、口头禅、称呼（比如叫她“piggy”或她喜欢的昵称）。
- 注意安全和隐私，不向第三方泄露信息。
- 每次调用 DeepSeek 时，把 `SYSTEM_PROMPT` 放到对话最前面，并在之后拼接 RAG context。

### 10. 性能与安全性考虑

- 为 DeepSeek 请求增加：
- 超时控制 & 错误重试（如 1～2 次）。
- 最大 token 数限制（控制成本）。
- 对上传文件：
- 限制单文件大小，例如 5–10 MB。
- 过滤危险 MIME 类型，只接受文本和安全文档。
- 环境变量：
- 确保 `DEEPSEEK_API_KEY` 仅在 server 端可见（不暴露给前端）。

### 11. 开发与测试步骤

- 本地开发流程：

1. 安装新依赖，配置 `.env.local` 的 DeepSeek key。
2. 初始化 Chroma 客户端并在本地写入几条测试“记忆”。
3. 在浏览器中打开网站，测试右下角聊天窗口：

- 直接闲聊，确认人设语气正确。
- 让 Piggy 提到之前的某条心情记录，验证 Champ 能“回忆”出细节。

4. 测试心情记录保存后是否自动进向量库，并且立刻能被 RAG 检索到。
5. 测试文件上传 → 相关内容能被引用。

### 12. 后续可拓展方向（非本次必做）

- 为记忆添加“权重”或“时间衰减”，更关注最近的记录。
- 支持把重要对话片段反写回 Chroma 作为新的记忆。
- 把 Chroma 从本地迁移到云端服务，方便多人访问。

### To-dos

- [ ] 引入 DeepSeek 和 Chroma 相关依赖，并配置 `.env.local` 与基础客户端封装
- [ ] 实现 `lib/vectorStore.ts` 和向量检索/写入逻辑
- [ ] 实现 `/api/chat` 接口，串起 RAG 检索与 DeepSeek 调用
- [ ] 在心情记录保存流程中增加嵌入生成与写入向量库的逻辑
- [ ] 实现文件上传解析与批量写入 Chroma 的接口和前端入口
- [ ] 实现右下角圆形头像按钮与聊天弹窗 UI，并接入 `/api/chat`
- [ ] 编写和调优 Champ 的系统提示词，让回复风格贴近你的说话方式
- [ ] 在本地完整测试聊天、人设、心情记录入库与文件上传检索流程